<!-- PatientTreatmentFlow BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Apr 01 13:55:18 CEST 2015 -->
<bpel:process name="PatientTreatmentFlow"
         targetNamespace="http://www.PAHospital.org/WardService/"
         suppressJoinFailure="yes"
         xmlns:tns="http://www.PAHospital.org/WardService/"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:labcb="http://www.PAHospital.org/LabCallbackService/"
         xmlns:lab="http://www.PAHospital.org/LabService/"
         xmlns:pat="http://www.PAHospital.org/PatService/"
         xmlns:radcb="http://www.PAHospital.org/RadiologyCallbackService/"
         xmlns:rad="http://www.PAHospital.org/RadiologyService/"
         xmlns:transp="http://www.PAHospital.org/TransportationService/"
         >
         
    <!-- Import the client WSDL -->
	<bpel:import location="WardService.wsdl" namespace="http://www.PAHospital.org/WardService/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService-callback.wsdl" namespace="http://www.PAHospital.org/LabCallbackService/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService.wsdl" namespace="http://www.PAHospital.org/LabService/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="PatService.wsdl" namespace="http://www.PAHospital.org/PatService/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService-callback.wsdl" namespace="http://www.PAHospital.org/RadiologyCallbackService/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService.wsdl" namespace="http://www.PAHospital.org/RadiologyService/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="TranspService.wsdl" namespace="http://www.PAHospital.org/TransportationService/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />

	<bpel:partnerLinks>
		<bpel:partnerLink name="ward" partnerLinkType="tns:Ward" myRole="ward"/>
		<!-- <bpel:partnerLink name="lab" partnerLinkType="tns:Lab" myRole="testRequester" partnerRole="testExecutor"/>-->
		<bpel:partnerLink name="epr" partnerLinkType="tns:Epr" partnerRole="directory"/>
		<!-- <bpel:partnerLink name="rad" partnerLinkType="tns:Rad" myRole="radRequester" partnerRole="radExecutor"/>
		<bpel:partnerLink name="transp" partnerLinkType="tns:Transp" partnerRole="transpExecutor"/>-->
	</bpel:partnerLinks>
    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
	<bpel:variables>
		<bpel:variable name="admRequest" messageType="tns:OrderAdmissionRequest"/>
		<bpel:variable name="admResp" messageType="tns:OrderAdmissionResponse"/>
		<bpel:variable name="labDataReq" messageType="tns:EnterLabTestOrderDataRequest"/>
		<bpel:variable name="radDataReq" messageType="tns:EnterRadiologyOrderDataRequest"/>
		<bpel:variable name="viewReq" messageType="tns:ViewReportsRequest"/>
		<bpel:variable name="viewResp" messageType="tns:ViewReportsResponse"/>
		<bpel:variable name="eprReq" messageType="pat:GetPatientIDsRequest"/>
		<bpel:variable name="eprResp" messageType="pat:GetPatientIDsResponse"/>
		<bpel:variable name="patDataReq" messageType="pat:GetPatientByIDRequest"/>
		<bpel:variable name="patDataResp" messageType="pat:GetPatientByIDResponse"/>
		<bpel:variable name="createEPRReq" messageType="pat:CreatePatientRecordRequest"/>
		<bpel:variable name="createEPRResp" messageType="pat:CreatePatientRecordResponse"/>
    </bpel:variables>
	
	<bpel:sequence name="main">
		
        
        <bpel:receive name="receiveAdmissionOrder" partnerLink="ward" operation="OrderAdmission" portType="tns:Ward" createInstance="yes" variable="admRequest"></bpel:receive>
        <bpel:assign validate="no" name="assignName">
           
            <bpel:copy>
                <bpel:from><bpel:literal><s0:PatientName xmlns:s0="http://www.PAHospital.org/PatService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">s0:PatientName</s0:PatientName>
				</bpel:literal></bpel:from>
                <bpel:to variable="eprReq" part="PatientName"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="PatientData" variable="admRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
                </bpel:from>
                <bpel:to part="PatientName" variable="eprReq"></bpel:to>
            </bpel:copy>
        </bpel:assign>
        
        <bpel:invoke name="getIDsByName" partnerLink="epr" operation="GetPatientIDsByName" portType="pat:ElectronicPatientRecord" inputVariable="eprReq" outputVariable="eprResp"></bpel:invoke>
        
        
        
        
        
        <bpel:forEach parallel="no" counterName="Counter" name="LoopThroughIDsList">
            <bpel:startCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                <![CDATA[0]]>
            </bpel:startCounterValue>
            <bpel:finalCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[count($eprResp.PatientIDsList)]]></bpel:finalCounterValue>
            <bpel:scope name="Scope">
                <bpel:sequence name="LoopSequence">
                    <bpel:assign validate="no" name="assignPatientID">
                        <bpel:copy>
                            <bpel:from><bpel:literal><s0:PatientID xmlns:s0="http://www.PAHospital.org/PatService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">s0:PatientID</s0:PatientID>
</bpel:literal></bpel:from>
                            <bpel:to variable="patDataReq" part="PatientID"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="PatientIDsList" variable="eprResp">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[PatientID[$Counter]]]>
                                </bpel:query>
                            </bpel:from>
                            <bpel:to part="PatientID" variable="patDataReq"></bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="getPatientInfo" partnerLink="epr" operation="GetPatientByID" portType="pat:ElectronicPatientRecord" inputVariable="patDataReq" outputVariable="patDataResp"></bpel:invoke>
                    
                    <bpel:if name="CheckIfSamePatient">
                        <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$admRequest.PatientData[PatientBirthday]=$patDataResp.Patient[PatientBirthday]]]></bpel:condition>
                        <bpel:assign validate="no" name="AssignPatientID">
                            <bpel:copy>
                                <bpel:from><bpel:literal><tns:PatientID xmlns:tns="http://www.PAHospital.org/WardService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">tns:PatientID</tns:PatientID>
</bpel:literal></bpel:from>
                                <bpel:to variable="admResp" part="ID">
                                	<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="Patient" variable="patDataResp">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="ID" variable="admResp">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
								</bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                    </bpel:if>
                </bpel:sequence>
            </bpel:scope>
        </bpel:forEach>
        <bpel:if name="CheckIfExists">
            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$admResp.ID[PatientID]=""]]></bpel:condition>
            <bpel:sequence>
                <bpel:assign validate="no" name="AssignIDAndData">
                    <bpel:copy>
                        <bpel:from><bpel:literal><s0:Patient xmlns:s0="http://www.PAHospital.org/PatService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <PatientID>PatientID</PatientID>
  <PatientName>PatientName</PatientName>
  <PatientStreet>PatientStreet</PatientStreet>
  <PatientZipCode>0</PatientZipCode>
  <PatientCity>PatientCity</PatientCity>
  <PatientBirthday>2001-01-01</PatientBirthday>
</s0:Patient>
</bpel:literal></bpel:from>
                        <bpel:to variable="createEPRReq" part="Patient"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$admRequest.PatientData[PatientName]+"1"]]>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[PatientID]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientStreet]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientStreet]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientZipCode]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientZipCode]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientCity]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientCity]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[PatientBirthday]]>
                            </bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientBirthday]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="MakeRecord" partnerLink="epr" operation="CreatePatientRecord" portType="pat:ElectronicPatientRecord" inputVariable="createEPRReq" outputVariable="createEPRResp"></bpel:invoke>
                
                <bpel:assign validate="no" name="AssignPatientID">
                    <bpel:copy>
                        <bpel:from><bpel:literal><tns:PatientID xmlns:tns="http://www.PAHospital.org/WardService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">tns:PatientID</tns:PatientID>
</bpel:literal></bpel:from>
                        <bpel:to variable="admResp" part="PatientID"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientID" variable="createEPRResp"></bpel:from>
                        <bpel:to part="PatientID" variable="admResp"></bpel:to>
                    </bpel:copy>
                </bpel:assign>
            </bpel:sequence>
        </bpel:if>
        <bpel:assign validate="no" name="AssignCaseID">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal xml:space="preserve">1</bpel:literal>
                </bpel:from>
                <bpel:to part="CaseID" variable="admResp"></bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:reply name="ReplyAdmissionOrder" partnerLink="ward" operation="OrderAdmission" portType="tns:Ward" variable="admResp"></bpel:reply>
        
    </bpel:sequence>    
</bpel:process>


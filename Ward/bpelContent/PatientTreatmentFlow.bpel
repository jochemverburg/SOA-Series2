<!-- PatientTreatmentFlow BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Apr 01 13:55:18 CEST 2015 -->
<bpel:process name="PatientTreatmentFlow" targetNamespace="http://www.PAHospital.org/WardService/"
	suppressJoinFailure="yes" xmlns:tns="http://www.PAHospital.org/WardService/"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:labcb="http://www.PAHospital.org/LabCallbackService/" xmlns:lab="http://www.PAHospital.org/LabService/"
	xmlns:pat="http://www.PAHospital.org/PatService/" xmlns:radcb="http://www.PAHospital.org/RadiologyCallbackService/"
	xmlns:rad="http://www.PAHospital.org/RadiologyService/" xmlns:transp="http://www.PAHospital.org/TransportationService/"
	exitOnStandardFault="no">

	<!-- Import the client WSDL -->
	<bpel:import location="WardService.wsdl" namespace="http://www.PAHospital.org/WardService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService-callback.wsdl" namespace="http://www.PAHospital.org/LabCallbackService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService.wsdl" namespace="http://www.PAHospital.org/LabService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="PatService.wsdl" namespace="http://www.PAHospital.org/PatService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService-callback.wsdl" namespace="http://www.PAHospital.org/RadiologyCallbackService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService.wsdl" namespace="http://www.PAHospital.org/RadiologyService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="TranspService.wsdl" namespace="http://www.PAHospital.org/TransportationService/" importType="http://schemas.xmlsoap.org/wsdl/" />

	<bpel:partnerLinks>
		<bpel:partnerLink name="ward" partnerLinkType="tns:Ward"
			myRole="ward" />
		<bpel:partnerLink name="lab" partnerLinkType="tns:Lab"
			myRole="testRequester" partnerRole="testExecutor" />
		<bpel:partnerLink name="epr" partnerLinkType="tns:Epr"
			partnerRole="directory" />
		<bpel:partnerLink name="rad" partnerLinkType="tns:Rad"
			myRole="radRequester" partnerRole="radExecutor" />
		<bpel:partnerLink name="transp" partnerLinkType="tns:transp" myRole="transpRequester" partnerRole="transpExecutor" />
		
	</bpel:partnerLinks>
	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->         
    <bpel:variables>
		<bpel:variable name="admRequest" messageType="tns:OrderAdmissionRequest"/>
		<bpel:variable name="admResp" messageType="tns:OrderAdmissionResponse"/>
		<bpel:variable name="labDataReq" messageType="tns:EnterLabTestOrderDataRequest"/>
		<bpel:variable name="radDataReq" messageType="tns:EnterRadiologyOrderDataRequest"/>
		<bpel:variable name="viewLabReq" messageType="tns:ViewLabReportRequest"/>
		<bpel:variable name="viewLabResp" messageType="tns:ViewLabReportResponse"/>
		<bpel:variable name="viewRadReq" messageType="tns:ViewRadiologyReportRequest"/>
		<bpel:variable name="viewRadResp" messageType="tns:ViewRadiologyReportResponse"/>
		<bpel:variable name="eprReq" messageType="pat:GetPatientIDsRequest"/>
		<bpel:variable name="eprResp" messageType="pat:GetPatientIDsResponse"/>
		<bpel:variable name="patDataReq" messageType="pat:GetPatientByIDRequest"/>
		<bpel:variable name="patDataResp" messageType="pat:GetPatientByIDResponse"/>
		<bpel:variable name="createEPRReq" messageType="pat:CreatePatientRecordRequest"/>
		<bpel:variable name="createEPRResp" messageType="pat:CreatePatientRecordResponse"/>
		<bpel:variable name="labTestReq" messageType="lab:LaboratoryOrderLabTestRequest"/>
		<bpel:variable name="labTestRes" messageType="lab:LaboratoryOrderLabTestResponse"/>
        <bpel:variable name="labReport" messageType="labcb:SendLabReportResponse"/>
        <bpel:variable name="storeLabReportReq" messageType="pat:StoreLabReportRequest"/>
        <bpel:variable name="radReq" messageType="rad:RadiologyOrderRadExaminationRequest"/>
        <bpel:variable name="radReport" messageType="radcb:RadiologyReportRequest"/>
        <bpel:variable name="radResponse" messageType="rad:RadiologyOrderRadExaminationResponse"/>
        <bpel:variable name="labTestID" element="lab:LabOrderId"/>
        <bpel:variable name="radReportID" element="rad:RadiologyOrderID"/>
        <bpel:variable name="radResponse1" messageType="rad:RadiologyRequestAppointmentResponse"/>
        <bpel:variable name="radRequest" messageType="rad:RadiologyRequestAppointmentRequest"/>
        <bpel:variable name="radAppointment" element="rad:Appointment"/>
    </bpel:variables>
	<bpel:flow name="main">
    	<bpel:links>
    		<bpel:link name="admission-to-patientcheck" />
			<bpel:link name="start-to-lab" />
			<bpel:link name="start-to-rad" />
        </bpel:links>
       
      

        <bpel:receive name="receiveAdmissionOrder" partnerLink="ward" operation="OrderAdmission" portType="tns:Ward" createInstance="yes" variable="admRequest">
        	<bpel:sources>
        		<bpel:source linkName="admission-to-patientcheck"></bpel:source>
        	</bpel:sources>
        </bpel:receive>
        
       <bpel:sequence>
       <bpel:targets>
       		<bpel:target linkName="admission-to-patientcheck"><bpel:target />
       </bpel:targets>
        <bpel:sources>
	        	<bpel:source linkName="start-to-lab"></bpel:source>
	        	<bpel:source linkName="start-to-rad"></bpel:source>
	        </bpel:sources> 
        <bpel:assign validate="no" name="assignName">
           
            <bpel:copy>
                <bpel:from><bpel:literal><s0:PatientName xmlns:s0="http://www.PAHospital.org/PatService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">s0:PatientName</s0:PatientName>
				</bpel:literal></bpel:from>
                <bpel:to variable="eprReq" part="PatientName"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="PatientData" variable="admRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
                </bpel:from>
                <bpel:to part="PatientName" variable="eprReq"></bpel:to>
            </bpel:copy>
        </bpel:assign>
        
        <bpel:invoke name="getIDsByName" partnerLink="epr" operation="GetPatientIDsByName" portType="pat:ElectronicPatientRecord" inputVariable="eprReq" outputVariable="eprResp"></bpel:invoke>
                
        
        
        
        <bpel:if name="CheckIfExists">
            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$admResp.PatientID]]></bpel:condition>
            <bpel:sequence>
                <bpel:assign validate="no" name="AssignIDAndData">
                    <bpel:copy>
                        <bpel:from><bpel:literal><s0:Patient xmlns:s0="http://www.PAHospital.org/PatService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
						  <PatientID>PatientID</PatientID>
						  <PatientName>PatientName</PatientName>
						  <PatientStreet>PatientStreet</PatientStreet>
						  <PatientZipCode>0</PatientZipCode>
						  <PatientCity>PatientCity</PatientCity>
						  <PatientBirthday>2001-01-01</PatientBirthday>
						</s0:Patient>
						</bpel:literal></bpel:from>
                        <bpel:to variable="createEPRReq" part="Patient"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$admRequest.PatientData[PatientName]+"1"]]>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[PatientID]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientStreet]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientStreet]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientZipCode]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientZipCode]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientCity]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientCity]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="PatientData" variable="admRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[PatientBirthday]]>
                            </bpel:query>
                        </bpel:from>
                        <bpel:to part="Patient" variable="createEPRReq">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientBirthday]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="MakeRecord" partnerLink="epr" operation="CreatePatientRecord" portType="pat:ElectronicPatientRecord" inputVariable="createEPRReq" outputVariable="createEPRResp"></bpel:invoke>
                
                </bpel:sequence> 
           
        </bpel:if>
        
        <bpel:reply name="ReplyAdmissionOrder" partnerLink="ward" operation="OrderAdmission" portType="tns:Ward" variable="admResp">
	      
        </bpel:reply>
       </bpel:sequence>
     
       <bpel:sequence name="Sequence">       
			<bpel:targets>
				<bpel:target linkName="start-to-lab"></bpel:target>
            </bpel:targets>
			<bpel:receive name="ReceiveLabOrderData" partnerLink="ward" operation="EnterLabTestOrderData" portType="tns:Ward"></bpel:receive>
            <bpel:assign validate="no" name="AssignLabOrderData">
                 <bpel:copy>
                    <bpel:from part="LabTestData" variable="labDataReq"></bpel:from>
                    <bpel:to part="LabOrder" variable="labTestReq"></bpel:to>
                </bpel:copy>
            </bpel:assign>
            <bpel:invoke name="RequestLabResults" partnerLink="lab" operation="OrderLabTest" inputVariable="labTestReq" portType="lab:Laboratory" outputVariable="labTestID"></bpel:invoke>
            <bpel:receive name="ReceiveLabResults" partnerLink="lab" operation="SendLabReport" variable="labReport" portType="labcb:LabCallback"></bpel:receive>
            <bpel:invoke name="StoreLabReport" partnerLink="epr" operation="StoreLabReport" portType="pat:ElectronicPatientRecord" inputVariable="storeLabReportReq"></bpel:invoke>        
        </bpel:sequence>
     

    	<bpel:sequence>
    	    <bpel:targets>
				 <bpel:target linkName="start-to-rad"></bpel:target>
            </bpel:targets>
            
            <bpel:receive name="ReceiveRadOrderData" partnerLink="ward" operation="EnterRadiologyOrderData" portType="tns:Ward" variable="radDataReq"></bpel:receive>
            <bpel:assign validate="no" name="AssignRadOrderData">
                 <bpel:copy>
                    <bpel:from part="RadOrderData" variable="radDataReq"></bpel:from>
                    <bpel:to part="Order" variable="radReq"></bpel:to>
                </bpel:copy>
            </bpel:assign>
            <bpel:invoke name="RequestRadReport" partnerLink="rad" operation="OrderRadiologyExamination" inputVariable="radReq" outputVariable="radReportID"></bpel:invoke>
            
            
            <bpel:invoke name="InvokeRequestRadiologyAppointment" partnerLink="rad" operation="RequestAppointment" portType="rad:Radiology" inputVariable="radAppointment" outputVariable="radAppointment"></bpel:invoke>
           
            <bpel:if name="transportRequired">
                <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$radReq.TransportRequired =true]]></bpel:condition>
                <bpel:sequence>
                
                </bpel:sequence>
            </bpel:if>
            <bpel:receive name="ReceiveRadReport" partnerLink="rad" operation="SendRadiologyReport" variable="radReport" portType="radcb:RadiologyCallback"></bpel:receive>
    	  
    	</bpel:sequence>   
    
        
    
    </bpel:flow>
</bpel:process>

